<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Layout 布局系统 - CUTLASS Notes</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Layout \u5e03\u5c40\u7cfb\u7edf";
        var mkdocs_page_input_path = "cute_layout.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> CUTLASS Notes
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">CuTe</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../cute_core/">Cute 核心概念</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Layout 布局系统</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#layout">Layout 基本概念</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#layout_1">Layout 的数学表示</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout_2">Layout 的创建</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#layout_3">基本 Layout 创建</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#layout_4">Layout 的组合</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#composed-layout">Composed Layout（组合布局）</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#composed-layout_1">Composed Layout 的组成</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#composed-layout_2">Composed Layout 的数学表示</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#composed-layout_3">Composed Layout 的创建</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#composed-layout-composition">Composed Layout 与 composition 的关系</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout_5">Layout 操作</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_1">基本操作</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#layout_6">Layout 组合示例</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout-tensor">Layout 在 Tensor 中的应用</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout_7">Layout 的类型</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#layout_8">基本 Layout 类型</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#layout_9">特殊 Layout</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout_10">Layout 的属性</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_2">基本属性</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_3">示例</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout_11">Layout 的转换</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_4">常见转换</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#layout_12">Layout 转换示例</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout_13">Layout 的实际应用</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_5">内存访问优化</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_6">数据重排</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_7">硬件适配</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout-copy">Layout 与 Copy 操作</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#layout-mma">Layout 与 MMA 操作</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cute_tensor/">Tensor 张量操作</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Copy 操作</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../cute_copy/">Copy 操作详解</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cute_tma_copy/">TMA Copy 操作</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >MMA 操作</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../cute_mma/">MMA 操作详解</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cute_wgmma_sm90/">GMMA(SM90)</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cute_examples/">实际应用示例</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CUTLASS Notes</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">CuTe</li>
      <li class="breadcrumb-item active">Layout 布局系统</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="cute-layout">CuTe Layout 布局系统</h1>
<p>Layout 是 CuTe 的核心概念之一，它描述了逻辑坐标到线性内存位置的映射关系。通过 Layout，CuTe 能够实现复杂的数据重排和内存访问模式。</p>
<h2 id="layout">Layout 基本概念</h2>
<p>Layout 定义了从多维逻辑坐标到一维线性位置（通常以位或字节为单位）的映射。它由两个主要部分组成：</p>
<ul>
<li>Shape（形状）：描述每个维度的大小</li>
<li>Stride（步幅）：描述每个维度的跨度</li>
</ul>
<h3 id="layout_1">Layout 的数学表示</h3>
<p>Layout 可以表示为一个函数：</p>
<pre><code>L(c) = sum(c[i] * stride[i]) for i in range(rank)
</code></pre>
<p>其中 c 是逻辑坐标，stride 是步幅向量，L(c) 是线性偏移量。</p>
<h2 id="layout_2">Layout 的创建</h2>
<p>Layout 可以通过多种方式创建：</p>
<h3 id="layout_3">基本 Layout 创建</h3>
<pre><code class="language-cpp">// 创建一个 2D 行主序 Layout
auto layout_2d = make_layout(make_shape(3, 4), GenRowMajor{});
// 等价于 make_layout(make_shape(3, 4), make_stride(4, 1));

// 创建一个 2D 列主序 Layout
auto layout_2d_col = make_layout(make_shape(3, 4), GenColMajor{});
// 等价于 make_layout(make_shape(3, 4), make_stride(1, 3));
</code></pre>
<h3 id="layout_4">Layout 的组合</h3>
<p>Layout 可以通过多种方式组合，创建更复杂的内存访问模式：</p>
<pre><code class="language-cpp">// 组合两个 Layout
auto layout_combined = make_layout(make_shape(Shape&lt;_2,_3&gt;{}, Shape&lt;_4,_5&gt;{}),
                                   make_stride(Stride&lt;_1,_6&gt;{}, Stride&lt;_2,_7&gt;{}));
</code></pre>
<h2 id="composed-layout">Composed Layout（组合布局）</h2>
<p>Composed Layout 是 CuTe 中一种强大的抽象，它通过组合多个布局和变换来实现复杂的数据转换。它提供了一种灵活的方式来操作内存布局和坐标系统。</p>
<h3 id="composed-layout_1">Composed Layout 的组成</h3>
<p>Composed Layout 由三个关键组件组成：</p>
<p><strong>内部布局/变换</strong>（inner）：</p>
<ul>
<li>可以是布局、交换操作（swizzle）或自定义变换函数</li>
<li>应用于坐标的最终变换</li>
<li>支持任意的坐标操作</li>
</ul>
<p><strong>偏移量</strong>（offset）：</p>
<ul>
<li>通常表示为整数元组</li>
<li>向坐标添加常量位移</li>
<li>实现对数据位置的精细控制</li>
</ul>
<p><strong>外部布局</strong>（outer）：</p>
<ul>
<li>用户可见的布局</li>
<li>定义初始的坐标变换</li>
<li>确定数据结构的形状和组织方式</li>
</ul>
<h3 id="composed-layout_2">Composed Layout 的数学表示</h3>
<p>这些组件的数学组合定义为：</p>
<pre><code>R(c) := (inner ∘ offset ∘ outer)(c) := inner(offset + outer(c))
</code></pre>
<p>其中：
- c 代表输入坐标
- ∘ 表示函数组合
- 变换从右到左应用</p>
<h3 id="composed-layout_3">Composed Layout 的创建</h3>
<p>在 C++ 中，可以通过以下方式创建 Composed Layout：</p>
<pre><code class="language-cpp">// 创建一个 Composed Layout
auto composed_layout = make_composed_layout(inner, offset, outer);
</code></pre>
<p>在 CuTe 的 GMMA 操作中，经常使用 Composed Layout 来描述共享内存的布局，特别是当涉及 swizzle 操作时：</p>
<pre><code class="language-cpp">// M|N-major GMMA layouts in units of bits
using Layout_MN_INTER_Atom_Bits = ComposedLayout&lt;Swizzle&lt;0,4,3&gt;, smem_ptr_flag, Layout&lt;Shape&lt; _128,_8&gt;,Stride&lt;_1, _128&gt;&gt;&gt;;
using Layout_MN_SW32_Atom_Bits  = ComposedLayout&lt;Swizzle&lt;1,4,3&gt;, smem_ptr_flag, Layout&lt;Shape&lt; _256,_8&gt;,Stride&lt;_1, _256&gt;&gt;&gt;;
using Layout_MN_SW64_Atom_Bits  = ComposedLayout&lt;Swizzle&lt;2,4,3&gt;, smem_ptr_flag, Layout&lt;Shape&lt; _512,_8&gt;,Stride&lt;_1, _512&gt;&gt;&gt;;
using Layout_MN_SW128_Atom_Bits = ComposedLayout&lt;Swizzle&lt;3,4,3&gt;, smem_ptr_flag, Layout&lt;Shape&lt;_1024,_8&gt;,Stride&lt;_1,_1024&gt;&gt;&gt;;
</code></pre>
<h3 id="composed-layout-composition">Composed Layout 与 composition 的关系</h3>
<p>Composed Layout 与 composition 操作密切相关，但它们有不同的用途和特点：</p>
<p><strong>composition 函数</strong>：</p>
<ul>
<li>composition 是 CuTe 中的一个函数，用于将两个 Layout 进行组合</li>
<li>它可以创建一个新的 Layout，表示两个 Layout 的函数组合</li>
<li>语法：<code>composition(layoutA, layoutB)</code> 或 <code>layoutA.compose(layoutB)</code></li>
</ul>
<p><strong>Composed Layout</strong>：</p>
<ul>
<li>Composed Layout 是一个特定的类型，用于表示无法通过普通 composition 函数组合的布局</li>
<li>它专门用于处理当"可除性条件"不满足时的情况</li>
<li>它由三个部分组成：inner layout、offset 和 outer layout</li>
</ul>
<p><strong>两者关系</strong>：</p>
<ul>
<li>Composed Layout 是 composition 概念的一种扩展实现</li>
<li>当普通 composition 无法应用时，可以使用 Composed Layout</li>
<li>Composed Layout 提供了与普通 Layout 类似的功能，包括切片、分区、坐标到索引的映射等</li>
</ul>
<p>示例：</p>
<pre><code class="language-cpp">// 使用 composition 函数组合两个普通 Layout
auto layoutA = make_layout(make_shape(6, 2), make_stride(8, 2));
auto layoutB = make_layout(make_shape(4, 3), make_stride(3, 1));
auto result = composition(layoutA, layoutB); // 结果是一个普通 Layout

// 使用 Composed Layout 处理更复杂的情况
auto swizzle = Swizzle&lt;3,4,3&gt;{};
auto offset = Int&lt;0&gt;{};
auto layout = make_layout(make_shape(1024, 8), make_stride(1, 1024));
auto composed = make_composed_layout(swizzle, offset, layout);
</code></pre>
<h2 id="layout_5">Layout 操作</h2>
<p>CuTe 提供了丰富的 Layout 操作函数，用于创建、转换和组合 Layout。</p>
<h3 id="_1">基本操作</h3>
<ul>
<li><strong>composition</strong>：组合两个 Layout</li>
<li><strong>complement</strong>：计算 Layout 的补集</li>
<li><strong>compact</strong>：创建紧凑版本的 Layout</li>
<li><strong>coalesce</strong>：合并连续的维度</li>
<li><strong>flatten</strong>：展平 Layout</li>
</ul>
<h3 id="layout_6">Layout 组合示例</h3>
<pre><code class="language-cpp">// 创建两个 Layout
auto layout_a = make_layout(make_shape(2, 3), make_stride(1, 2));
auto layout_b = make_layout(make_shape(6, 1), make_stride(1, 0));

// 组合 Layout
auto composed_layout = composition(layout_a, layout_b);
</code></pre>
<h2 id="layout-tensor">Layout 在 Tensor 中的应用</h2>
<p>Layout 与 Tensor 紧密结合，定义了 Tensor 数据在内存中的存储方式。</p>
<pre><code class="language-cpp">// 创建一个带有特定 Layout 的 Tensor
auto tensor = make_tensor(make_gmem_ptr&lt;float&gt;(ptr), 
                         make_layout(make_shape(16, 32), GenRowMajor{}));
</code></pre>
<h2 id="layout_7">Layout 的类型</h2>
<p>CuTe 提供了多种预定义的 Layout 类型：</p>
<h3 id="layout_8">基本 Layout 类型</h3>
<ul>
<li><strong>Layout</strong>：基本的 Layout 类型，由 Shape 和 Stride 组成，用于描述任意维度的数据布局</li>
<li><strong>LogicalLayout</strong>：逻辑 Layout，用于描述逻辑坐标空间的布局，不直接关联物理内存地址</li>
<li><strong>PhysicalLayout</strong>：物理 Layout，用于描述物理内存中的实际布局，与具体的内存地址相关联</li>
</ul>
<h3 id="layout_9">特殊 Layout</h3>
<ul>
<li><strong>GenRowMajor</strong>：生成行主序 Layout，创建按行优先顺序排列的内存布局</li>
<li><strong>GenColMajor</strong>：生成列主序 Layout，创建按列优先顺序排列的内存布局</li>
<li><strong>Swizzle</strong>：内存交换 Layout，用于在共享内存中实现特定的内存访问模式以优化性能</li>
</ul>
<h2 id="layout_10">Layout 的属性</h2>
<p>Layout 具有多种属性，可以通过函数获取：</p>
<h3 id="_2">基本属性</h3>
<ul>
<li><strong>rank</strong>：Layout 的维度数</li>
<li><strong>size</strong>：Layout 覆盖的元素总数</li>
<li><strong>cosize</strong>：Layout 的共大小</li>
</ul>
<h3 id="_3">示例</h3>
<pre><code class="language-cpp">auto layout = make_layout(make_shape(3, 4), make_stride(4, 1));

// 获取 Layout 属性
auto layout_rank = rank(layout);  // 返回 2
auto layout_size = size(layout);  // 返回 12
</code></pre>
<h2 id="layout_11">Layout 的转换</h2>
<p>Layout 可以进行多种转换操作：</p>
<h3 id="_4">常见转换</h3>
<ul>
<li><strong>recast</strong>：重新解释 Layout 的元素类型</li>
<li><strong>right_inverse</strong>：计算 Layout 的右逆</li>
<li><strong>left_inverse</strong>：计算 Layout 的左逆</li>
<li><strong>zip</strong>：压缩多个 Layout</li>
</ul>
<h3 id="layout_12">Layout 转换示例</h3>
<pre><code class="language-cpp">// 创建一个 Layout
auto layout = make_layout(make_shape(4, 4), make_stride(1, 4));

// 计算右逆
auto inv_layout = right_inverse(layout);
</code></pre>
<h2 id="layout_13">Layout 的实际应用</h2>
<p>Layout 在实际应用中发挥着重要作用：</p>
<h3 id="_5">内存访问优化</h3>
<p>通过合理设计 Layout，可以优化内存访问模式，提高缓存命中率和内存带宽利用率。</p>
<h3 id="_6">数据重排</h3>
<p>Layout 可以实现复杂的数据重排操作，如矩阵转置、分块等。</p>
<h3 id="_7">硬件适配</h3>
<p>Layout 可以适配不同的硬件特性，如向量化内存访问、共享内存交换等。</p>
<h2 id="layout-copy">Layout 与 Copy 操作</h2>
<p>Layout 在 Copy 操作中起着关键作用，它定义了源和目标数据的内存布局。</p>
<pre><code class="language-cpp">// 定义源 Layout 和目标 Layout
auto src_layout = make_layout(make_shape(16, 16), GenRowMajor{});
auto dst_layout = make_layout(make_shape(16, 16), GenColMajor{});

// 创建 Tensors
auto src_tensor = make_tensor(src_ptr, src_layout);
auto dst_tensor = make_tensor(dst_ptr, dst_layout);

// 执行 Copy 操作（包含转置）
copy(src_tensor, dst_tensor);
</code></pre>
<h2 id="layout-mma">Layout 与 MMA 操作</h2>
<p>在 MMA (Matrix Multiply-Accumulate) 操作中，Layout 定义了矩阵元素在寄存器和内存中的布局。</p>
<pre><code class="language-cpp">// 定义 MMA 操作相关的 Layout
using MMA_LAYOUT = Layout&lt;Shape&lt;_2,_2&gt;, Stride&lt;_1,_2&gt;&gt;;

// 使用 Layout 创建 MMA 操作
auto mma_layout = MMA_LAYOUT{};
</code></pre>
<p>Layout 是 CuTe 系统中的核心抽象之一，通过它实现了对复杂内存访问模式的灵活控制，为高性能计算提供了基础支持。</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../cute_core/" class="btn btn-neutral float-left" title="Cute 核心概念"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cute_tensor/" class="btn btn-neutral float-right" title="Tensor 张量操作">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../cute_core/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cute_tensor/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
